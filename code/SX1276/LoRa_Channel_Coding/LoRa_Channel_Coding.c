#include "LoRa_Channel_Coding.h"
#include <string.h>
#include <stdlib.h>
//#include "malloc.h" 

//#define DEBUG
#ifdef DEBUG
#include "usart.h"
#endif

const uint16_t gray_code_template[]={
	
// sf 11 0x31 * 255
0x464,     0x3fc,     0x4cc,     0x598,     0xc4 ,
0x798,     0x6ac,     0x4c0,     0x678,     0x25c,
0x64 ,     0x404,     0x4c4,     0x674,     0x470,
0x368,     0xb4 ,     0x4f4,     0x614,     0x114,
0x568,     0x1e0,     0x70c,     0x1e4,     0x458,
0x558,     0x4d0,     0x3c ,     0x180,     0xfc ,
0x53c,     0x148,     0x1a0,     0xbc ,     0x5b0,
0x50c,     0x47c,     0x160,     0x33c,     0xe4 ,
0x310,     0x2e8,     0x11c,     0x23c,     0x6c8,
0x32c,     0x7c4,     0x610,     0x224,     0x45c,
0x4d4,     0x29c,     0x60c,     0x3e4,     0x290,
0x4e8,     0x7b0,     0x6fc,     0x3f8,     0x604,
0x36c,     0x214,     0x71c,     0x238,     0xac ,
0x6c ,     0x6b7,     0x70f,     0x1d7,     0x203,
0x613,     0x71b,     0x507,     0x613,     0x433,
0x6d3,     0x3cb,     0x203,     0x5ef,     0x76b,
0xb3 ,     0x5a3,     0x77 ,     0x30b,     0x223,
0x387,     0x173,     0x773,     0xe7 ,     0x13f,
0x40f,     0x30f,     0x50f,     0x623,     0x473,
0x70f,     0x7bb,     0x51b,     0x5c3,     0x6db,
0x68f,     0x613,     0x717,     0x233,     0x387,
0x65f,     0x29f,     0xd7 ,     0x1af,     0x71f,
0x7df,     0x4f3,     0x2d7,     0x64b,     0x16f,
0x7df,     0x19f,     0x523,     0x5b3,     0x3d7,
0x77 ,     0x437,     0x4b7,     0x573,     0x613,
0x3b7,     0x113,     0x447,     0x693,     0x33f,
0x5d7,     0x7f ,     0x5cb,     0x797,     0x60b,
0x627,     0x5cb,     0x1ff,     0x3ff,     0x4a3,
0x633,     0x757,     0x277,     0x4ef,     0x16b,
0x607,     0x26f,     0x283,     0x4ef,     0x3f3,
0x6b ,     0x413,     0x317,     0x5cb,     0x6a3,
0x9f ,     0xd7 ,     0x427,     0x653,     0x3cb,
0x15b,     0x66f,     0x7d3,     0x53 ,     0x503,
0x26b,     0x2b7,     0xe7 ,     0x2b ,     0x79f,
0x46b,     0x3eb,     0x30f,     0x61f,     0x20f,
0x44f,     0x6bf,     0x41b,     0x637,     0x83 ,
0x44f,     0x393,     0x41b,     0x7c3,     0x52b,
0x45b,     0x6db,     0x41f,     0x7b7,     0x647,
0x437,     0x343,     0x5bb,     0x777,     0x3f7,
0x403,     0x66b,     0x53f,     0x483,     0x9b ,
0x27b,     0x33 ,     0x49f,     0x543,     0x653,
0x27b,     0x563,     0x34f,     0x69f,     0x2ef,
0x3fb,     0x32f,     0x2aa,     0x69e,     0x79e,
0x3be,     0x616,     0x5aa,     0x556,     0x2c2,
0x5c2,     0xba ,     0x5ae,     0x496,     0x466,
0x6f6,     0x46a,     0x2ba,     0x47e,     0x6ee,


//sf12 0x31 * 255
//0x5cc,     0x200,     0x598,     0xb30,     0xf1c,
//0xde4,     0xda8,     0x2cc,     0x59c,     0x114,
//0x5f0,     0x27c,     0x298,     0x530,     0x62c,
//0xd34,     0xc08,     0x18c,     0x4df,     0x53f,
//0xa53,     0x2cb,     0x3f7,     0x3ef,     0xbf7,
//0x9e7,     0xa4b,     0x2fb,     0x5ff,     0x67 ,
//0xbc7,     0xe0b,     0xd7f,     0x4f7,     0x59b,
//0x623,     0xa2b,     0x5bf,     0xb7f,     0x467,
//0xccf,     0xfc3,     0xe0f,     0x423,     0x89f,
//0xa67,     0x2af,     0x4f7,     0xdef,     0x2c7,
//0x937,     0xbeb,     0x1bb,     0x77b,     0x43b,
//0x46b,     0xebb,     0xcdf,     0x237,     0x847,
//0x2f7,     0xc67,     0x6af,     0x95f,     0x13f,
//0xd4b,     0x303,     0x67 ,     0x32b,     0x6c3,
//0x5a3,     0x2cf,     0x3c3,     0x6f ,     0x6c7,
//0xe1f,     0xa23,     0x22b,     0x79f,     0x8fe,
//0x81e,     0x61e,     0xdd6,     0x446,     0xee6,
//0x70e,     0x83e,     0x91a,     0xa36,     0xdda,
//0x346,     0xf06,     0x86e,     0xce2,     0xc42,
//0xe62,     0x552,     0x4c6,     0xe6a,     0x3b2,
//0x6fe,     0x79a,     0xea2,     0x6b2,     0x78a,
//0xf7a,     0x896,     0x8aa,     0xd56,     0x95e,
//0x47a,     0x15e,     0xb56,     0xeb2,     0x216,
//0xeca,     0xbf6,     0x66a,     0x8da,     0x462,
//0x752,     0x72e,     0xff6,     0x3f2,     0x766,
//0xc66,     0xeb2,     0xb0a,     0xe16,     0x51e,
//0x606,     0x58a,     0x576,     0x90a,     0x706,
//0x32 ,     0x9f2,     0xd8a,     0x4e2,     0x9ce,
//0xfd2,     0x632,     0xa05,     0xbe6,     0xeae,
//0x425,     0x1ca,     0xa01,     0xbf1,     0x2f9,
//0xdd5,     0xdd1,     0x5c9,     0xb99,     0x821,
//0x51d,     0x3d9,     0x1d5,     0x449,     0x275,
//0x28d,     0xcb5,     0xe9 ,     0x21d,     0x891,
//0xe85,     0x485,     0x85 ,     0x10d,     0xecd,
//0x871,     0x689,     0xc81,     0x105,     0xe09,
//0x401,     0xe69,     0xab9,     0x975,     0x199,
//0x139,     0xbe1,     0x64d,     0xb59,     0x951,
//0x99 ,     0x755,     0xf25,     0x251,     0xdfd,
//0xf7d,     0x695,     0xb51,     0xea5,     0xe51,
//0x739,     0x7dd,     0x9a1,     0x8b1,     0xeb9,
//0xfa9,     0x935,     0xbe9,     0xc21,     0xd31,
//0xbd5,     0x1cd,     0xa34,     0x870,     0xfc9,
//0xa0c,     0xdb8,     0x518,     0xa38,     0x148,


};                               



int *LoRa_Channel_Coding(uint8_t *tx_buffer, uint16_t buffer_size, uint32_t bw, uint8_t sf, uint8_t cr, bool has_crc, bool impl_head, int *symbol_len)
{
	int i;
	uint8_t *whitened_data = NULL;
	uint8_t *add_header_data = NULL;
	uint8_t *add_CRC_data = NULL;
	uint8_t *hanmingcode_data = NULL;
	uint16_t *interleaver_data = NULL;
	uint16_t *gray_data = NULL;
	int 	*modulation_data = NULL;
	
	uint16_t noutput_whitening = 0;
	uint16_t noutput_add_header = 0;
	uint16_t noutput_add_CRC = 0;
	uint16_t noutput_hanmming_coding = 0;
	uint16_t noutput_interleaver = 0;
	uint16_t noutput_gray = 0;
	uint16_t noutput_modulation = 0;
	
	
//	if(sf == 11 || sf==12)
//	{
//		sf-=2;
//	}
	
	
	
	#ifdef DEBUG
	for(i=0;i<1;i++)
	{
		printf("Out[%d]:%x (hex)\n",i,tx_buffer[i]);
	}
	
	printf("\n------------------Whitening-----------------------\n");
	#endif
	
	whitened_data = Whitening(tx_buffer, buffer_size, &noutput_whitening);
	
	#ifdef DEBUG
	printf("Len of Output:%d\n",noutput_whitening);
	for(i=0;i<noutput_whitening;i++)
	{
		printf("Out[%d]:%x (hex)\n",i,whitened_data[i]);
	}
	printf("\n------------------Add header-----------------------\n");
	#endif
	
	add_header_data = Add_Header(impl_head, has_crc, cr, buffer_size, whitened_data, noutput_whitening, &noutput_add_header);
	
	free(whitened_data);
	
	#ifdef DEBUG
	printf("Len of Output:%d\n",noutput_add_header);
	for(i=0;i<noutput_add_header;i++)
	{
		printf("Out[%d]:%x (hex)\n",i,add_header_data[i]);
	}
	
	printf("\n------------------Add CRC-----------------------\n");
	#endif
	
	add_CRC_data = Add_CRC(has_crc, tx_buffer, buffer_size, add_header_data, noutput_add_header, &noutput_add_CRC);
	
	free(add_header_data);
	
	#ifdef DEBUG
	printf("Len of Output:%d\n",noutput_add_CRC);
	for(i=0;i<noutput_add_CRC;i++)
	{
		printf("Out[%d]:%x (hex)\n",i,add_CRC_data[i]);
	}
	
	printf("\n------------------Hanmming coding-----------------------\n");
	#endif
	
	hanmingcode_data = Hanmming_Enc(cr, sf, add_CRC_data, noutput_add_CRC, &noutput_hanmming_coding);
	
	free(add_CRC_data);
	
	#ifdef DEBUG
	printf("Len of Output:%d\n",noutput_hanmming_coding);
	for(i=0;i<noutput_hanmming_coding;i++)
	{
		printf("Out[%d]:%x (hex)\n",i,hanmingcode_data[i]);
	}
	
	printf("\n------------------Interleaver-----------------------\n");
	#endif
	
	interleaver_data = Interleaver(cr, sf, hanmingcode_data, noutput_hanmming_coding, &noutput_interleaver);
	
	free(hanmingcode_data);
	
	#ifdef DEBUG
	printf("Len of Output:%d\n",noutput_interleaver);
	for(i=0;i<noutput_interleaver;i++)
	{
		printf("Out[%d]:%x (hex)\n",i,interleaver_data[i]);
	}
	
	printf("\n------------------Gray coder-----------------------\n");
	#endif
	
	gray_data = Gray_Decoder(cr, sf, interleaver_data, noutput_interleaver, &noutput_gray);
	
	free(interleaver_data);
	
//	for(i=8;i<noutput_gray;i++)
//	{
//		gray_data[i]=gray_code_template[i-8]+1;
//	}
//	for(i=0;i<noutput_interleaver;i++)
//	{
//		printf("Out[%d]:0x%x\n",i,gray_data[i]);
//	}
	
	#ifdef DEBUG
	printf("Len of Output:%d\n",noutput_gray);
	for(i=0;i<noutput_interleaver;i++)
	{
		printf("Out[%d]:0x%x\n",i,gray_data[i]);
	}
	
	printf("\n------------------Modualtion-----------------------\n");
	#endif
	
	

	
	
	
	modulation_data = Modulation(cr, sf, bw, gray_data, noutput_gray, &noutput_modulation);
	
	free(gray_data);
	
	#ifdef DEBUG
	printf("Len of Output:%d\n",noutput_modulation);
	for(i=0;i<noutput_modulation;i++)
	{
		printf("Out[%d]:\t%d,\t (int)\n",i,modulation_data[i]);
	}
	
	#endif
	
	*symbol_len = noutput_modulation;
	
	
	return modulation_data;
	
	
	
}
